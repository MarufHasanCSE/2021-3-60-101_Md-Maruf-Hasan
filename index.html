<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSE407 IoT Energy Monitoring Dashboard - Enhanced Precision</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .header h1 {
            color: white;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }
        .card h2 {
            color: #4a5568;
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .icon {
            width: 24px;
            height: 24px;
            fill: #667eea;
        }
        .device-status {
            grid-column: 1 / -1;
            text-align: center;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .status-indicator.offline {
            background: #ef4444;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .status-indicator.connecting {
            background: #f59e0b;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            min-width: 150px;
        }
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .control-btn.off {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }
        .control-btn.off:hover {
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
        }
        .control-btn.secondary {
            background: linear-gradient(135deg, #38b2ac, #319795);
            box-shadow: 0 4px 15px rgba(56, 178, 172, 0.3);
        }
        .control-btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(56, 178, 172, 0.4);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .metric {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 15px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .metric:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-unit {
            font-size: 1rem;
            color: #4a5568;
        }
        .chart-container {
            position: relative;
            height: 500px; /* Increased height for better visibility */
            margin-top: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chart-loading {
            color: #666;
            font-style: italic;
        }
        .device-info {
            background: linear-gradient(135deg, #e6fffa, #b2f5ea);
            border: 1px solid #81e6d9;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: left;
        }
        .device-info h3 {
            color: #234e52;
            margin-bottom: 0.5rem;
        }
        .device-info p {
            color: #2c7a7b;
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }
        .api-status {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border: 1px solid #a5b4fc;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        .api-status h3 {
            color: #3730a3;
            margin-bottom: 0.5rem;
        }
        .api-status p {
            color: #4338ca;
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        .alert.success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 1px solid #34d399;
            color: #064e3b;
        }
        .alert.error {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        .alert.warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .alert.info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 1px solid #60a5fa;
            color: #1e3a8a;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .csv-upload {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            border: 2px dashed #fc8181;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        .csv-upload:hover {
            border-color: #f56565;
            background: linear-gradient(135deg, #fed7d7, #fbb6ce);
        }
        .csv-upload input[type="file"] {
            margin: 1rem 0;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: white;
        }
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .data-table {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            margin-top: 1rem;
        }
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }
        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
        }
        .data-table tr:hover {
            background: #f7fafc;
        }
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #7dd3fc;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }
        .stat-card h4 {
            color: #0c4a6e;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0f172a;
        }
        .cost-analysis {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1rem;
        }
        .cost-analysis h4 {
            color: #92400e;
            margin-bottom: 1rem;
        }
        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }
        .cost-item {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #7dd3fc;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }
        .cost-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #92400e;
        }
        .cost-label {
            font-size: 0.8rem;
            color: #d97706;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            .control-panel {
                flex-direction: column;
                align-items: center;
            }
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .drag-over {
            border-color: #10b981 !important;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important;
        }
        .hidden {
            display: none;
        }
        .mode-switcher {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
        }
        .mode-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin: 0 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .mode-btn.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Enhanced Chart Controls */
        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .chart-toggle-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .chart-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .chart-toggle-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .data-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #7dd3fc;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #0c4a6e;
            text-align: center;
        }
        
        .large-chart {
            grid-column: 1 / -1;
        }
        
        .large-chart .chart-container {
            height: 600px;
        }

        /* Mode-specific visibility */
        .csv-mode-only {
            display: block;
        }
        
        .api-mode-only {
            display: none;
        }
        
        .api-mode .csv-mode-only {
            display: none;
        }
        
        .api-mode .api-mode-only {
            display: block;
        }

        .realtime-message {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            margin: 2rem 0;
            color: #92400e;
        }

        .realtime-message h3 {
            margin-bottom: 1rem;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="text-align: center;">🏠 CSE407 IoT Energy Monitoring Dashboard By Md Maruf Hasan</h1>
        <h3 style="text-align: center; color: white;">| ID: 2021-3-60-101 | Tuya Smart Plug Energy Monitor | Refrigerator Analysis |</h3>

        <div class="mode-switcher">
            <button class="mode-btn active" onclick="switchMode('csv')">📊 CSV Analysis Mode</button>
            <button class="mode-btn" onclick="switchMode('api')">🔴 Real-time API Mode</button>
        </div>
    </div>

    <div class="container" id="main-container">
        <!-- Device Status & Control -->
        <div class="card device-status">
            <div class="status-indicator" id="status-indicator">
                <div class="status-dot"></div>
                <span id="device-status-text">Ready for Data Analysis</span>
            </div>
            
            <div class="api-status">
                <h3>🔌 Tuya Smart Plug Status</h3>
                <p><strong>Device ID:</strong> bf0d5b3c1720e925e0f14a</p>
                <p><strong>Connected Device:</strong> Walton Refrigerator (180L)</p>
                <p><strong>Data Source:</strong> <span id="data-source">CSV Historical Data</span></p>
                <p><strong>Device Online:</strong> <span id="online-status">✅ Online</span></p>
                <p><strong>Power State:</strong> <span id="power-state">ON</span></p>
                <p><strong>Last Update:</strong> <span id="last-update">--</span></p>
            </div>
            
            <div class="device-info">
                <h3>Device Information</h3>
                <p><strong>Product:</strong> Tuya Smart WiFi Plug (20A)</p>
                <p><strong>Voltage Rating:</strong> 220-240V AC</p>
                <p><strong>Current Rating:</strong> 20A Max</p>
                <p><strong>Power Rating:</strong> 4400W Max</p>
                <p><strong>Location:</strong> Hostel - Refrigerator</p>
            </div>

            <div class="control-panel">
                <button class="control-btn" id="power-btn" onclick="toggleDevice()">
                    <span id="btn-text">🟢 Turn OFF</span>
                </button>
                <button class="control-btn secondary" onclick="refreshData()">
                    🔄 Refresh Data
                </button>
                <button class="control-btn secondary" onclick="exportData()">
                    📥 Export Data
                </button>
            </div>

            <div class="alert success" id="alert" style="display: none;">
                <strong>Status:</strong> <span id="alert-message"></span>
            </div>
        </div>

        <!-- CSV Upload - CSV Mode Only -->
        <div class="card csv-mode-only">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Data Upload & Analysis
            </h2>
            
            <div class="csv-upload" id="csv-upload-area">
                <h4>📊 Upload Tuya CSV Data</h4>
                <p>Upload historical data exported from Tuya IoT Platform</p>
                <p><small>Format: Time, Device Event, DP ID, Event Details, Source</small></p>
                <input type="file" id="csvFile" accept=".csv" onchange="handleCSVUpload(event)">
                <button class="btn" onclick="document.getElementById('csvFile').click()">Browse CSV File</button>
                <button class="btn" onclick="loadSampleData()">Load Sample Data</button>
            </div>

            <div id="csv-status" class="alert info" style="display: none;">
                <span id="csv-message">No data loaded. Please upload CSV file.</span>
            </div>

            <div id="debug-info" class="debug-info" style="display: none;">
                <strong>Debug Information:</strong><br>
                <div id="debug-content"></div>
            </div>
        </div>

        <!-- Real-time API Message - API Mode Only -->
        <div class="card api-mode-only">
            <div class="realtime-message">
                <h3>🔴 Real-time API Mode Active</h3>
                <p>In this mode, only live data monitoring is available. Charts and historical analysis are disabled.</p>
                <p>Switch to CSV Analysis Mode to access full dashboard features.</p>
            </div>
        </div>

        <!-- Current Metrics -->
        <div class="card">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                </svg>
                Current Metrics
            </h2>
            
            <div class="metrics-grid">
                <div class="metric">
                    <div class="metric-value" id="current-power">--<span class="metric-unit">W</span></div>
                    <div class="metric-label">Current Power</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="current-voltage">--<span class="metric-unit">V</span></div>
                    <div class="metric-label">Voltage</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="current-current">--<span class="metric-unit">mA</span></div>
                    <div class="metric-label">Current</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="total-energy">--<span class="metric-unit">kWh</span></div>
                    <div class="metric-label">Total Energy</div>
                </div>
            </div>
        </div>

        <!-- Statistics - CSV Mode Only -->
        <div class="card csv-mode-only">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M7.5,4A5.5,5.5 0 0,0 2,9.5C2,10 2.09,10.5 2.22,11H6.3L7.57,7.63C7.87,6.83 9.05,6.75 9.43,7.63L11.5,13L12.09,11.58C12.22,11.25 12.57,11 12.96,11H21.77C21.91,10.5 22,10 22,9.5A5.5,5.5 0 0,0 16.5,4C14.64,4 13,4.92 12,6.34C11,4.92 9.36,4 7.5,4V4M3,12.5A1,1 0 0,0 2,13.5A1,1 0 0,0 3,14.5H6.4L7.58,16.37C7.87,17.17 9.05,17.25 9.43,16.37L11.5,11L12.09,12.42C12.22,12.75 12.57,13 12.96,13H21A1,1 0 0,0 22,12A1,1 0 0,0 21,11H13.6L10.32,19.63C10.03,20.43 8.85,20.51 8.47,19.63L6.4,14.5L5.47,16.37C5.2,17 4.53,17.37 3.83,17.21C3.13,17.05 2.7,16.41 2.7,15.69V12.5H3Z"/>
                </svg>
                Data Statistics
            </h2>
            
            <div class="statistics-grid" id="data-statistics">
                <div class="stat-card">
                    <h4>Total Records</h4>
                    <div class="stat-value" id="total-records">--</div>
                </div>
                <div class="stat-card">
                    <h4>Time Period</h4>
                    <div class="stat-value" id="date-range" style="font-size: 1.2rem;">--</div>
                </div>
                <div class="stat-card">
                    <h4>Average Power</h4>
                    <div class="stat-value" id="avg-power">-- W</div>
                </div>
                <div class="stat-card">
                    <h4>Peak Power</h4>
                    <div class="stat-value" id="max-power">-- W</div>
                </div>
                <div class="stat-card">
                    <h4>Min Power</h4>
                    <div class="stat-value" id="min-power">-- W</div>
                </div>
                <div class="stat-card">
                    <h4>Voltage Range</h4>
                    <div class="stat-value" id="voltage-range" style="font-size: 1.2rem;">-- V</div>
                </div>
            </div>

           
        </div>
         <div class="cost-analysis">
                <h4>💰 Fixed Cost Analysis (BDT @ ৳6.0/kWh)</h4>
                <div class="cost-grid">
                    <div class="cost-item">
                        <div class="cost-value" id="daily-cost" style="font-size: 26px; font-weight: bold;">৳--</div>
                        <div class="cost-label" style="font-size: 16px; font-weight: bold;">Hourly Est. Average</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-value" id="monthly-cost" style="font-size: 26px; font-weight: bold;">৳--</div>
                        <div class="cost-label" style="font-size: 16px; font-weight: bold;">Hourly Est. Cost</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-value" id="yearly-cost" style="font-size: 26px; font-weight: bold;">৳--</div>
                        <div class="cost-label" style="font-size: 16px; font-weight: bold;">Monthly Est. Cost</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-value" id="total-cost" style="font-size: 26px; font-weight: bold;">৳--</div>
                        <div class="cost-label" style="font-size: 16px; font-weight: bold;">Period Est. Total</div>
                    </div>
                </div>
            </div>

        <!-- Enhanced Power Chart - CSV Mode Only -->
        <div class="card large-chart csv-mode-only">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/>
                </svg>
                Power Consumption Analysis - Enhanced Precision
            </h2>
            
            <div class="chart-controls">
                <button class="chart-toggle-btn active" id="power-full-btn" onclick="toggleChartView('power', 'full')">
                    📊 Full Data View
                </button>
                <button class="chart-toggle-btn" id="power-hourly-btn" onclick="toggleChartView('power', 'hourly')">
                    ⏰ Hourly Summary
                </button>
                <button class="chart-toggle-btn" id="power-daily-btn" onclick="toggleChartView('power', 'daily')">
                    📅 Daily Summary
                </button>
            </div>
            
            <div class="data-info" id="power-data-info">
                Showing all data points with precise timestamps from CSV file
            </div>
            
            <div class="chart-container" id="power-chart-container">
                <div class="chart-loading">Loading chart...</div>
                <canvas id="powerChart" style="display: none;"></canvas>
            </div>
        </div>

        <!-- Enhanced Voltage Chart - CSV Mode Only -->
        <div class="card large-chart csv-mode-only">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"/>
                </svg>
                Voltage Stability Monitoring - Enhanced Precision
            </h2>
            
            <div class="chart-controls">
                <button class="chart-toggle-btn active" id="voltage-full-btn" onclick="toggleChartView('voltage', 'full')">
                    📊 Full Data View
                </button>
                <button class="chart-toggle-btn" id="voltage-hourly-btn" onclick="toggleChartView('voltage', 'hourly')">
                    ⏰ Hourly Summary
                </button>
                <button class="chart-toggle-btn" id="voltage-daily-btn" onclick="toggleChartView('voltage', 'daily')">
                    📅 Daily Summary
                </button>
            </div>
            
            <div class="data-info" id="voltage-data-info">
                Showing all data points with precise timestamps from CSV file
            </div>
            
            <div class="chart-container" id="voltage-chart-container">
                <div class="chart-loading">Loading chart...</div>
                <canvas id="voltageChart" style="display: none;"></canvas>
            </div>
        </div>

        <!-- Enhanced Current Chart - CSV Mode Only -->
        <div class="card large-chart csv-mode-only">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M7.5,4A5.5,5.5 0 0,0 2,9.5C2,10 2.09,10.5 2.22,11H6.3L7.57,7.63C7.87,6.83 9.05,6.75 9.43,7.63L11.5,13L12.09,11.58C12.22,11.25 12.57,11 12.96,11H21.77C21.91,10.5 22,10 22,9.5A5.5,5.5 0 0,0 16.5,4C14.64,4 13,4.92 12,6.34C11,4.92 9.36,4 7.5,4V4M3,12.5A1,1 0 0,0 2,13.5A1,1 0 0,0 3,14.5H6.4L7.58,16.37C7.87,17.17 9.05,17.25 9.43,16.37L11.5,11L12.09,12.42C12.22,12.75 12.57,13 12.96,13H21A1,1 0 0,0 22,12A1,1 0 0,0 21,11H13.6L10.32,19.63C10.03,20.43 8.85,20.51 8.47,19.63L6.4,14.5L5.47,16.37C5.2,17 4.53,17.37 3.83,17.21C3.13,17.05 2.7,16.41 2.7,15.69V12.5H3Z"/>
                </svg>
                Current Load Analysis - Enhanced Precision
            </h2>
            
            <div class="chart-controls">
                <button class="chart-toggle-btn active" id="current-full-btn" onclick="toggleChartView('current', 'full')">
                    📊 Full Data View
                </button>
                <button class="chart-toggle-btn" id="current-hourly-btn" onclick="toggleChartView('current', 'hourly')">
                    ⏰ Hourly Summary
                </button>
                <button class="chart-toggle-btn" id="current-daily-btn" onclick="toggleChartView('current', 'daily')">
                    📅 Daily Summary
                </button>
            </div>
            
            <div class="data-info" id="current-data-info">
                Showing all data points with precise timestamps from CSV file
            </div>
            
            <div class="chart-container" id="current-chart-container">
                <div class="chart-loading">Loading chart...</div>
                <canvas id="currentChart" style="display: none;"></canvas>
            </div>
        </div>

        <!-- Enhanced Energy Chart - CSV Mode Only -->
        <div class="card large-chart csv-mode-only">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
            </svg>
            Energy Consumption (kWh) - Enhanced Precision
        </h2>
        
        <div class="chart-controls">
            <button class="chart-toggle-btn active" id="energy-full-btn" onclick="toggleChartView('energy', 'full')">
                📊 Full Data View
            </button>
            <button class="chart-toggle-btn" id="energy-hourly-btn" onclick="toggleChartView('energy', 'hourly')">
                ⏰ Hourly Summary
            </button>
            <button class="chart-toggle-btn" id="energy-daily-btn" onclick="toggleChartView('energy', 'daily')">
                📅 Daily Summary
            </button>
        </div>
        
        <div class="data-info" id="energy-data-info">
            Showing cumulative energy consumption with precise timestamps
        </div>
        
        <div class="chart-container" id="energy-chart-container">
            <div class="chart-loading">Loading chart...</div>
            <canvas id="energyChart" style="display: none;"></canvas>
        </div>
    </div>

        <!-- Data Table -->
        <div class="card full-width">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M5,7H19V5H5V7Z"/>
                </svg>
                Historical Data Table - Precise Timestamps
            </h2>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Exact Timestamp</th>
                            <th>Parameter</th>
                            <th>Value</th>
                            <th>Unit</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <tr>
                            <td colspan="5" class="no-data">
                                No data loaded. Please upload CSV file from Tuya platform.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentMode = 'csv';
        let deviceState = {
            isOnline: true,
            isPowered: true,
            historicalData: [],
            rawData: []
        };
        let charts = {
            power: null,
            voltage: null,
            current: null,
            energy: null
        };
        let chartViews = {
            power: 'full',
            voltage: 'full',
            current: 'full',
            energy: 'full'
        };
        const ELECTRICITY_RATE = 6.0; // BDT per kWh

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            console.log('Chart.js version:', Chart.version);
            initializeCharts();
            setupDragAndDrop();
            showAlert('info', 'Enhanced dashboard initialized. Upload CSV data to see precise timestamps.');
        });

        // Load sample data for testing
        async function loadSampleData() {
            try {
                showCSVStatus('warning', 'Loading sample data from Tuya platform...');
                
                const response = await fetch('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/fridge_data_updated_time-cg300NbYrLuu52zrlG4ocMJaJTSauv.csv');
                const csvData = await response.text();
                
                console.log('Sample data loaded, first 500 chars:', csvData.substring(0, 500));
                
                const parsedData = parseTuyaCSVData(csvData);
                console.log('Parsed data:', parsedData.slice(0, 5));
                
                if (parsedData.length === 0) {
                    throw new Error('No valid energy data found in sample CSV file');
                }
                
                deviceState.rawData = csvData.split('\n');
                deviceState.historicalData = parsedData;
                
                updateAllAnalysis();
                showCSVStatus('success', `Successfully loaded ${parsedData.length} data points with precise timestamps (${getDateRange()})`);
                showAlert('success', `Enhanced CSV data loaded! Analyzing ${parsedData.length} records with precise timestamps.`);
                
            } catch (error) {
                console.error('Sample data loading error:', error);
                showCSVStatus('error', `Error loading sample data: ${error.message}`);
                showAlert('error', `Failed to load sample data: ${error.message}`);
            }
        }

        // Enhanced Mode switching with proper visibility control
        function switchMode(mode) {
            // Clean up any existing real-time intervals
            if (window.realTimeInterval) {
                clearInterval(window.realTimeInterval);
                window.realTimeInterval = null;
            }

            currentMode = mode;
            const container = document.getElementById('main-container');
            
            // Update active button
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === 'csv') {
                // CSV Analysis Mode - Show all features
                container.classList.remove('api-mode');
                document.getElementById('device-status-text').textContent = 'CSV Analysis Mode - Full Features Available';
                document.getElementById('data-source').textContent = 'CSV Historical Data';
                
                // Clear real-time data and show CSV data
                updateDataTable();
                
                showAlert('success', 'CSV Analysis Mode activated - All dashboard features are now available');
            } else {
                // Real-time API Mode - Hide charts, show only data table
                container.classList.add('api-mode');
                document.getElementById('device-status-text').textContent = 'Real-time API Mode - Live Monitoring Only';
                document.getElementById('data-source').textContent = 'Tuya Cloud API';
                
                // Clear CSV data from table
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">
                            Real-time data will appear here when device is active...
                        </td>
                    </tr>
                `;
                
                showAlert('info', 'Real-time API Mode activated - Charts hidden, only live data monitoring available');
                
                // Start real-time simulation immediately
                setTimeout(() => {
                    startRealTimeSimulation();
                }, 1000);
            }
        }

        // Chart view toggle function
        function toggleChartView(chartType, viewType) {
            if (currentMode !== 'csv') {
                showAlert('warning', 'Chart controls are only available in CSV Analysis Mode');
                return;
            }
            
            chartViews[chartType] = viewType;
            
            // Update button states
            document.querySelectorAll(`#${chartType}-full-btn, #${chartType}-hourly-btn, #${chartType}-daily-btn`)
                .forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${chartType}-${viewType}-btn`).classList.add('active');
            
            // Update data info
            const infoElement = document.getElementById(`${chartType}-data-info`);
            switch(viewType) {
                case 'full':
                    infoElement.textContent = 'Showing ALL individual timestamps from CSV file - Maximum precision';
                    break;
                case 'hourly':
                    infoElement.textContent = 'Showing hourly averages for better overview';
                    break;
                case 'daily':
                    infoElement.textContent = 'Showing daily averages for trend analysis';
                    break;
            }
            
            // Update the specific chart
            updateSingleChart(chartType);
            showAlert('info', `${chartType.charAt(0).toUpperCase() + chartType.slice(1)} chart updated to ${viewType} view`);
        }

        // Real-time simulation for API mode
        function startRealTimeSimulation() {
            if (currentMode !== 'api') return;
            
            console.log('Starting real-time API simulation...');
            
            // Clear any existing intervals
            if (window.realTimeInterval) {
                clearInterval(window.realTimeInterval);
            }
            
            // Simulate real-time data updates every 2 seconds
            window.realTimeInterval = setInterval(() => {
                if (currentMode === 'api' && deviceState.isPowered) {
                    simulateRealTimeData();
                } else {
                    clearInterval(window.realTimeInterval);
                    window.realTimeInterval = null;
                }
            }, 2000);
            
            // Start immediately
            if (deviceState.isPowered) {
                simulateRealTimeData();
            }
        }

        function simulateRealTimeData() {
            const now = new Date();
            
            // Simulate realistic refrigerator power consumption with cycling
            const baseLoad = 0.15; // 150W base
            const variation = Math.sin(Date.now() / 10000) * 0.05; // Cycling pattern
            const randomNoise = (Math.random() - 0.5) * 0.02;
            const power = baseLoad + variation + randomNoise;
            
            // Realistic voltage with small fluctuations
            const voltage = 220 + (Math.random() - 0.5) * 8; // 216-224V range
            
            // Calculate current from power and voltage
            const current = (power * 1000) / voltage; // Convert to mA
            
            console.log(`Real-time data: ${power.toFixed(3)}W, ${voltage.toFixed(1)}V, ${current.toFixed(1)}mA`);
            
            updateCurrentMetrics(power, voltage, current);
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
            
            // Add to real-time data table
            addRealTimeDataToTable(now, power, voltage, current);
        }

        function addRealTimeDataToTable(timestamp, power, voltage, current) {
            const tbody = document.getElementById('data-table-body');
            
            // Clear any existing "No data loaded" message when adding real-time data
            if (tbody.children.length === 1 && tbody.children[0].textContent.includes('No data loaded')) {
                tbody.innerHTML = '';
            }
            
            const preciseTimestamp = timestamp.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            // Add power reading
            const powerRow = document.createElement('tr');
            powerRow.innerHTML = `
                <td>${preciseTimestamp}</td>
                <td>Power</td>
                <td>${power.toFixed(4)}</td>
                <td>W</td>
                <td>Real-time API</td>
            `;
            powerRow.style.backgroundColor = '#e6fffa';
            tbody.insertBefore(powerRow, tbody.firstChild);

            // Add voltage reading
            const voltageRow = document.createElement('tr');
            voltageRow.innerHTML = `
                <td>${preciseTimestamp}</td>
                <td>Voltage</td>
                <td>${voltage.toFixed(2)}</td>
                <td>V</td>
                <td>Real-time API</td>
            `;
            voltageRow.style.backgroundColor = '#e6fffa';
            tbody.insertBefore(voltageRow, tbody.firstChild);

            // Add current reading
            const currentRow = document.createElement('tr');
            currentRow.innerHTML = `
                <td>${preciseTimestamp}</td>
                <td>Current</td>
                <td>${current.toFixed(1)}</td>
                <td>mA</td>
                <td>Real-time API</td>
            `;
            currentRow.style.backgroundColor = '#e6fffa';
            tbody.insertBefore(currentRow, tbody.firstChild);

            // Keep only last 50 entries in API mode
            while (tbody.children.length > 150) { // 50 entries × 3 parameters
                tbody.removeChild(tbody.lastChild);
            }
        }

        // Device control functions
        function toggleDevice() {
            const btn = document.getElementById('power-btn');
            const btnText = document.getElementById('btn-text');
            const powerState = document.getElementById('power-state');
            const onlineStatus = document.getElementById('online-status');
            const statusIndicator = document.getElementById('status-indicator');
            
            if (deviceState.isPowered) {
                // Turn OFF
                deviceState.isPowered = false;
                deviceState.isOnline = false;
                btn.classList.add('off');
                btnText.textContent = '🔴 Turn ON';
                powerState.textContent = 'OFF';
                onlineStatus.textContent = '❌ Offline';
                statusIndicator.classList.add('offline');
                document.getElementById('device-status-text').textContent = 'Device Offline';
                showAlert('warning', 'Device turned OFF - Smart plug is now offline');
            } else {
                // Turn ON
                deviceState.isPowered = true;
                deviceState.isOnline = true;
                btn.classList.remove('off');
                btnText.textContent = '🟢 Turn OFF';
                powerState.textContent = 'ON';
                onlineStatus.textContent = '✅ Online';
                statusIndicator.classList.remove('offline');
                const modeText = currentMode === 'csv' ? 'CSV Analysis Mode - Full Features Available' : 'Real-time API Mode - Live Monitoring Only';
                document.getElementById('device-status-text').textContent = modeText;
                showAlert('success', 'Device turned ON - Smart plug is now online and monitoring');
            }
        }

        function refreshData() {
            if (currentMode === 'csv') {
                if (deviceState.historicalData.length > 0) {
                    updateAllAnalysis();
                    showAlert('success', 'Enhanced CSV data analysis refreshed with precise timestamps!');
                } else {
                    showAlert('warning', 'No CSV data to refresh. Please upload a file first.');
                }
            } else {
                simulateRealTimeData();
                showAlert('success', 'Real-time data refreshed from Tuya API!');
            }
        }

        function exportData() {
            if (currentMode === 'api') {
                showAlert('info', 'Export feature is available in CSV Analysis Mode only');
                return;
            }
            
            if (deviceState.historicalData.length === 0) {
                showAlert('warning', 'No data to export. Please load CSV data first.');
                return;
            }
            
            showAlert('info', 'Preparing enhanced data export with precise timestamps and kWh calculations...');
            
            let csvContent = "timestamp,parameter,value,unit,source,original_csv_time,precise_timestamp\n";
            
            deviceState.historicalData.forEach(record => {
                const originalTime = record.timestamp;
                const preciseTimestamp = new Date(originalTime).toISOString();
                const formattedTime = new Date(originalTime).toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                if (record.power !== null && record.power !== undefined) {
                    csvContent += `${formattedTime},Power,${record.power},W,Tuya Platform,${originalTime},${preciseTimestamp}\n`;
                    
                    // Add calculated energy
                    const timeInterval = 1; // 1 minute
                    const energyWh = (record.power * timeInterval) / 60;
                    const energyKWh = energyWh / 1000;
                    csvContent += `${formattedTime},Energy,${energyKWh.toFixed(6)},kWh,Calculated,${originalTime},${preciseTimestamp}\n`;
                }
                if (record.voltage !== null && record.voltage !== undefined) {
                    csvContent += `${formattedTime},Voltage,${record.voltage},V,Tuya Platform,${originalTime},${preciseTimestamp}\n`;
                }
                if (record.current !== null && record.current !== undefined) {
                    csvContent += `${formattedTime},Current,${record.current},mA,Tuya Platform,${originalTime},${preciseTimestamp}\n`;
                }
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tuya_energy_analysis_precise_timestamps_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('success', 'Enhanced data with precise timestamps and kWh calculations exported successfully!');
        }

        // CSV Upload handling
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('csv-upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
            });

            uploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleCSVFile(files[0]);
                }
            }, false);
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleCSVFile(file);
            }
        }

        function handleCSVFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showCSVStatus('error', 'Please select a CSV file');
                return;
            }

            showCSVStatus('warning', 'Processing CSV file with precise timestamp extraction...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    console.log('CSV file loaded, first 500 chars:', csvData.substring(0, 500));
                    
                    const parsedData = parseTuyaCSVData(csvData);
                    console.log('Parsed data with precise timestamps:', parsedData.slice(0, 5));
                    
                    if (parsedData.length === 0) {
                        throw new Error('No valid energy data found in CSV file');
                    }
                    
                    deviceState.rawData = csvData.split('\n');
                    deviceState.historicalData = parsedData;
                    
                    updateAllAnalysis();
                    showCSVStatus('success', `Successfully loaded ${parsedData.length} data points with precise timestamps (${getDateRange()})`);
                    showAlert('success', `Enhanced CSV data loaded! Analyzing ${parsedData.length} records with precise timestamps.`);
                    
                } catch (error) {
                    console.error('CSV parsing error:', error);
                    showCSVStatus('error', `Error parsing CSV: ${error.message}`);
                    showAlert('error', `Failed to parse CSV: ${error.message}`);
                    
                    // Show debug info
                    document.getElementById('debug-info').style.display = 'block';
                    document.getElementById('debug-content').innerHTML = `
                        Error: ${error.message}<br>
                        File size: ${file.size} bytes<br>
                        First 200 chars: ${csvData.substring(0, 200)}
                    `;
                }
            };
            
            reader.readAsText(file);
        }

        // Enhanced CSV parsing for Tuya format with precise timestamps
        function parseTuyaCSVData(csvText) {
            console.log('Starting enhanced CSV parsing with precise timestamps...');
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            const data = [];
            
            if (lines.length === 0) {
                console.log('No lines found in CSV');
                return data;
            }
            
            console.log(`Processing ${lines.length} lines`);
            console.log('First few lines:', lines.slice(0, 3));
            
            // Skip header line if it exists
            const startIndex = lines[0].toLowerCase().includes('time') || lines[0].toLowerCase().includes('device') ? 1 : 0;
            console.log(`Starting from line ${startIndex}`);
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];
                if (!line) continue;
                
                try {
                    const columns = parseCSVLine(line);
                    if (columns.length < 4) {
                        console.log(`Line ${i + 1}: Not enough columns (${columns.length})`);
                        continue;
                    }
                    
                    // Expected format: Time, Device Event, DP ID, Event Details, Source, Source Details
                    const timeStr = columns[0];
                    const deviceEvent = columns[1];
                    const dpId = columns[2];
                    const eventDetails = columns[3];
                    const source = columns[4] || 'device itself';
                    
                    // Parse timestamp with high precision
                    const timestamp = parseTimestamp(timeStr);
                    if (!timestamp) {
                        console.log(`Line ${i + 1}: Invalid timestamp: ${timeStr}`);
                        continue;
                    }
                    
                    const parsed = parseTuyaEventDetails(dpId, eventDetails);
                    if (!parsed) {
                        console.log(`Line ${i + 1}: Could not parse event details: ${dpId} = ${eventDetails}`);
                        continue;
                    }
                    
                    // Create individual record for each timestamp (no grouping)
                    const record = {
                        timestamp: timestamp.toISOString(),
                        originalTimestamp: timeStr,
                        power: null,
                        voltage: null,
                        current: null
                    };
                    
                    // Set the appropriate field
                    if (parsed.type === 'power') {
                        record.power = parsed.value;
                    } else if (parsed.type === 'voltage') {
                        record.voltage = parsed.value;
                    } else if (parsed.type === 'current') {
                        record.current = parsed.value;
                    }
                    
                    data.push(record);
                    
                } catch (error) {
                    console.warn(`Skipping line ${i + 1}: ${error.message}`);
                }
            }
            
            // Sort by timestamp to maintain chronological order
            data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            console.log(`Parsed ${data.length} individual data records with precise timestamps`);
            return data;
        }

        function parseTuyaEventDetails(dpId, eventDetails) {
            if (!dpId || !eventDetails) return null;
            
            const dpIdLower = dpId.toLowerCase();
            const detailsStr = eventDetails.toString();
            
            // Extract numeric value from event details
            const match = detailsStr.match(/([\d.]+)/);
            if (!match) {
                return null;
            }
            
            const value = parseFloat(match[1]);
            if (isNaN(value)) {
                return null;
            }
            
            // Determine parameter type based on DP ID
            if (dpIdLower.includes('power') || dpIdLower.includes('watt')) {
                return { type: 'power', value: value };
            } else if (dpIdLower.includes('voltage') || dpIdLower.includes('volt')) {
                return { type: 'voltage', value: value };
            } else if (dpIdLower.includes('current') || dpIdLower.includes('amp')) {
                return { type: 'current', value: value };
            }
            
            // Check event details for units
            if (detailsStr.toLowerCase().includes('w')) {
                return { type: 'power', value: value };
            } else if (detailsStr.toLowerCase().includes('v')) {
                return { type: 'voltage', value: value };
            } else if (detailsStr.toLowerCase().includes('ma') || detailsStr.toLowerCase().includes('amp')) {
                return { type: 'current', value: value };
            }
            
            return null;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        function parseTimestamp(timeStr) {
            if (!timeStr) return null;
            
            timeStr = timeStr.trim();
            const date = new Date(timeStr);
            return !isNaN(date.getTime()) ? date : null;
        }

        // Analysis and visualization functions
        function updateAllAnalysis() {
            console.log('Updating all analysis with enhanced precision...');
            if (deviceState.historicalData.length === 0) {
                console.log('No historical data available');
                return;
            }
            
            updateStatistics();
            updateCurrentMetricsFromData();
            if (currentMode === 'csv') {
                updateCharts();
            }
            updateDataTable();
            console.log('Enhanced analysis update complete');
        }

        function updateStatistics() {
            const data = deviceState.historicalData;
            if (data.length === 0) return;

            const totalRecords = data.length;
            const dates = data.map(d => new Date(d.timestamp));
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            const powerValues = data.map(d => d.power);
            const voltageValues = data.map(d => d.voltage);
            
            const avgPower = powerValues.length > 0 ? (powerValues.reduce((a, b) => a + b, 0) / powerValues.length) : 0;
            const maxPower = powerValues.length > 0 ? Math.max(...powerValues) : 0;
            const minPower = powerValues.length > 0 ? Math.min(...powerValues) : 0;
            
            const minVoltage = voltageValues.length > 0 ? Math.min(...voltageValues) : 0;
            const maxVoltage = voltageValues.length > 0 ? Math.max(...voltageValues) : 0;

            document.getElementById('total-records').textContent = totalRecords;
            document.getElementById('date-range').textContent = 
                `${minDate.toLocaleDateString()} to ${maxDate.toLocaleDateString()}`;
            document.getElementById('avg-power').textContent = `${avgPower.toFixed(3)} W`;
            document.getElementById('max-power').textContent = `${maxPower.toFixed(3)} W`;
            document.getElementById('min-power').textContent = `${minPower.toFixed(3)} W`;
            document.getElementById('voltage-range').textContent = `${minVoltage.toFixed(1)} - ${maxVoltage.toFixed(1)} V`;

            // FIXED Cost Analysis - More realistic calculations
            console.log('Starting enhanced cost analysis calculation...');

            // Calculate total time period in hours
            const totalMilliseconds = maxDate - minDate;
            const totalHours = totalMilliseconds / (1000 * 60 * 60);

            console.log(`Total time period: ${totalHours.toFixed(2)} hours`);
            console.log(`Average power: ${avgPower.toFixed(3)} W`);

            // For realistic refrigerator energy calculation
            // Assume continuous operation with cycling (refrigerators don't run 24/7 at full power)
            const operatingFactor = 0.4; // Refrigerators typically run 40% of the time
            const effectiveAvgPower = avgPower * operatingFactor;

            // Calculate total energy consumption
            let totalEnergyWh = 0;
            const sortedData = data.filter(d => d.power !== null).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (sortedData.length > 1) {
                for (let i = 1; i < sortedData.length; i++) {
                    const currentTime = new Date(sortedData[i].timestamp);
                    const previousTime = new Date(sortedData[i - 1].timestamp);
                    const timeDiffHours = (currentTime - previousTime) / (1000 * 60 * 60);
                    
                    const currentPower = sortedData[i].power;
                    const previousPower = sortedData[i - 1].power;
                    const avgPowerInterval = (currentPower + previousPower) / 2;
                    
                    const energyWh = avgPowerInterval * timeDiffHours;
                    totalEnergyWh += energyWh;
                }
            } else {
                // Fallback calculation if insufficient data points
                totalEnergyWh = effectiveAvgPower * totalHours;
            }

            const totalEnergyKWh = totalEnergyWh / 1000;
            const totalCost = totalEnergyKWh * ELECTRICITY_RATE;

            console.log(`Total energy: ${totalEnergyKWh.toFixed(6)} kWh`);
            console.log(`Total cost: ৳${totalCost.toFixed(2)}`);

            // Calculate realistic daily, monthly, yearly costs
            let dailyEnergyKWh, dailyCost, monthlyCost, yearlyCost;

            if (totalHours >= 24) {
                // If we have more than 24 hours of data, calculate based on actual consumption
                dailyEnergyKWh = totalEnergyKWh / (totalHours / 24);
            } else {
                // If less than 24 hours, extrapolate based on average power
                // Typical refrigerator: 150W average, running 40% of time = 60W effective
                // Daily energy = 60W × 24h = 1.44 kWh
                const typicalDailyKWh = (effectiveAvgPower * 24) / 1000;
                dailyEnergyKWh = Math.max(typicalDailyKWh, totalEnergyKWh * (24 / totalHours));
            }

            dailyCost = dailyEnergyKWh * ELECTRICITY_RATE;
            monthlyCost = dailyCost * 30;
            yearlyCost = dailyCost * 365;

            // Ensure minimum realistic values for refrigerator
            const minDailyCost = 1.0; // Minimum ৳1 per day for any refrigerator
            if (dailyCost < minDailyCost) {
                dailyCost = minDailyCost;
                monthlyCost = dailyCost * 30;
                yearlyCost = dailyCost * 365;
            }

            console.log(`Daily energy: ${dailyEnergyKWh.toFixed(6)} kWh, Daily cost: ৳${dailyCost.toFixed(2)}`);
            console.log(`Monthly cost: ৳${monthlyCost.toFixed(2)}, Yearly cost: ৳${yearlyCost.toFixed(2)}`);

            document.getElementById('daily-cost').textContent = `৳${dailyCost.toFixed(2)}`;
            document.getElementById('monthly-cost').textContent = `৳${monthlyCost.toFixed(0)}`;
            document.getElementById('yearly-cost').textContent = `৳${yearlyCost.toFixed(0)}`;
            document.getElementById('total-cost').textContent = `৳${totalCost.toFixed(2)}`;

            console.log('Enhanced cost analysis completed successfully');
        }

        function updateCurrentMetricsFromData() {
            const data = deviceState.historicalData;
            if (data.length === 0) return;

            const latest = data[data.length - 1];
            updateCurrentMetrics(latest.power, latest.voltage, latest.current);
            
            // Calculate total energy using proper integration
            let totalEnergyWh = 0;
            const sortedData = data.filter(d => d.power !== null).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            for (let i = 1; i < sortedData.length; i++) {
                const currentTime = new Date(sortedData[i].timestamp);
                const previousTime = new Date(sortedData[i - 1].timestamp);
                const timeDiffHours = (currentTime - previousTime) / (1000 * 60 * 60);
                
                const currentPower = sortedData[i].power;
                const previousPower = sortedData[i - 1].power;
                const avgPowerInterval = (currentPower + previousPower) / 2;
                
                const energyWh = avgPowerInterval * timeDiffHours;
                totalEnergyWh += energyWh;
            }
            
            const totalEnergyKWh = totalEnergyWh / 1000;
            
            document.getElementById('total-energy').innerHTML = 
                `${totalEnergyKWh.toFixed(4)}<span class="metric-unit">kWh</span>`;
                
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        function updateCurrentMetrics(power, voltage, current) {
            document.getElementById('current-power').innerHTML = 
                `${power ? power.toFixed(3) : '--'}<span class="metric-unit">W</span>`;
            document.getElementById('current-voltage').innerHTML = 
                `${voltage ? voltage.toFixed(1) : '--'}<span class="metric-unit">V</span>`;
            document.getElementById('current-current').innerHTML = 
                `${current ? current.toFixed(0) : '--'}<span class="metric-unit">mA</span>`;
        }

        function getDateRange() {
            if (deviceState.historicalData.length === 0) return '';
            
            const dates = deviceState.historicalData.map(d => new Date(d.timestamp));
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            return `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}`;
        }

        // Initialize charts with enhanced precision support
        function initializeCharts() {
            console.log('Initializing enhanced precision charts...');
            
            try {
                // Base time axis configuration - will be modified dynamically
                const baseTimeAxisConfig = {
                    type: 'time',
                    time: {
                        displayFormats: {
                            millisecond: 'HH:mm:ss.SSS',
                            second: 'HH:mm:ss',
                            minute: 'MMM dd HH:mm:ss',
                            hour: 'MMM dd HH:mm',
                            day: 'MMM dd yyyy',
                            week: 'MMM dd yyyy',
                            month: 'MMM yyyy',
                            quarter: 'MMM yyyy',
                            year: 'yyyy'
                        },
                        tooltipFormat: 'MMM dd, yyyy HH:mm:ss (GMT+0600)',
                        parser: 'YYYY-MM-DDTHH:mm:ss.SSSZ'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        maxTicksLimit: 20, // Default - will be overridden
                        autoSkip: true, // Default - will be overridden
                        callback: function(value, index, values) {
                            const date = new Date(value);
                            return date.toLocaleString('en-US', {
                                month: 'short',
                                day: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                timeZone: 'Asia/Dhaka',
                                timeZoneName: 'short'
                            });
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time (Precise Timestamps - Bangladesh Standard Time)'
                    }
                };

                // Power Chart
                const powerCtx = document.getElementById('powerChart').getContext('2d');
                charts.power = new Chart(powerCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Power (W)',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 1,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const date = new Date(context[0].parsed.x);
                                        return date.toLocaleString('en-US', {
                                            weekday: 'short',
                                            month: 'short',
                                            day: '2-digit',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            second: '2-digit',
                                            timeZone: 'Asia/Dhaka',
                                            timeZoneName: 'long'
                                        });
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Power (W)'
                                }
                            },
                            x: JSON.parse(JSON.stringify(baseTimeAxisConfig)) // Deep copy
                        }
                    }
                });

                // Voltage Chart
                const voltageCtx = document.getElementById('voltageChart').getContext('2d');
                charts.voltage = new Chart(voltageCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Voltage (V)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 1,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const date = new Date(context[0].parsed.x);
                                        return date.toLocaleString('en-US', {
                                            weekday: 'short',
                                            month: 'short',
                                            day: '2-digit',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            second: '2-digit',
                                            timeZone: 'Asia/Dhaka',
                                            timeZoneName: 'long'
                                        });
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Voltage (V)'
                                }
                            },
                            x: JSON.parse(JSON.stringify(baseTimeAxisConfig)) // Deep copy
                        }
                    }
                });

                // Current Chart
                const currentCtx = document.getElementById('currentChart').getContext('2d');
                charts.current = new Chart(currentCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Current (mA)',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 1,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const date = new Date(context[0].parsed.x);
                                        return date.toLocaleString('en-US', {
                                            weekday: 'short',
                                            month: 'short',
                                            day: '2-digit',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            second: '2-digit',
                                            timeZone: 'Asia/Dhaka',
                                            timeZoneName: 'long'
                                        });
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Current (mA)'
                                }
                            },
                            x: JSON.parse(JSON.stringify(baseTimeAxisConfig)) // Deep copy
                        }
                    }
                });

                // Energy Chart
                const energyCtx = document.getElementById('energyChart').getContext('2d');
                charts.energy = new Chart(energyCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Cumulative Energy (kWh)',
                            data: [],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 1,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const date = new Date(context[0].parsed.x);
                                        return date.toLocaleString('en-US', {
                                            weekday: 'short',
                                            month: 'short',
                                            day: '2-digit',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            second: '2-digit',
                                            timeZone: 'Asia/Dhaka',
                                            timeZoneName: 'long'
                                        });
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cumulative Energy (kWh)'
                                }
                            },
                            x: JSON.parse(JSON.stringify(baseTimeAxisConfig)) // Deep copy
                        }
                    }
                });
                
                console.log('Enhanced precision charts initialized successfully');
                
            } catch (error) {
                console.error('Chart initialization error:', error);
                showAlert('error', 'Failed to initialize charts: ' + error.message);
            }
        }

        // Enhanced chart update functions
        function updateCharts() {
            console.log('Updating all charts with enhanced precision...');
            updateSingleChart('power');
            updateSingleChart('voltage');
            updateSingleChart('current');
            updateSingleChart('energy');
        }

        function updateSingleChart(chartType) {
            const data = deviceState.historicalData;
            if (data.length === 0) {
                console.log(`No data for ${chartType} chart`);
                return;
            }

            try {
                const viewType = chartViews[chartType];
                let processedData = [];

                switch(viewType) {
                    case 'full':
                        processedData = prepareFullDataView(data, chartType);
                        break;
                    case 'hourly':
                        processedData = prepareHourlyDataView(data, chartType);
                        break;
                    case 'daily':
                        processedData = prepareDailyDataView(data, chartType);
                        break;
                }

                if (processedData.length === 0) {
                    console.log(`No processed data for ${chartType} chart`);
                    return;
                }

                const chart = charts[chartType];
                if (!chart) {
                    console.log(`Chart ${chartType} not initialized`);
                    return;
                }

                // ENHANCED: Configure time axis based on view type and data size
                if (chart.options && chart.options.scales && chart.options.scales.x) {
                    if (viewType === 'full') {
                        // For full data view, show ALL timestamps from CSV
                        chart.options.scales.x.ticks.maxTicksLimit = processedData.length; // Show ALL data points
                        chart.options.scales.x.ticks.autoSkip = false; // Don't skip any timestamps
                        chart.options.scales.x.time.displayFormats.minute = 'MMM dd HH:mm:ss';
                        chart.options.scales.x.time.displayFormats.hour = 'MMM dd HH:mm:ss';
                        console.log(`Full data view: Showing ALL ${processedData.length} timestamps`);
                    } else if (viewType === 'hourly') {
                        // For hourly view, show reasonable number of hour labels
                        chart.options.scales.x.ticks.maxTicksLimit = Math.min(processedData.length, 24);
                        chart.options.scales.x.ticks.autoSkip = processedData.length > 24;
                        chart.options.scales.x.time.displayFormats.hour = 'MMM dd HH:mm';
                        console.log(`Hourly view: Showing up to 24 hour labels`);
                    } else if (viewType === 'daily') {
                        // For daily view, show all days
                        chart.options.scales.x.ticks.maxTicksLimit = processedData.length;
                        chart.options.scales.x.ticks.autoSkip = false;
                        chart.options.scales.x.time.displayFormats.day = 'MMM dd yyyy';
                        console.log(`Daily view: Showing all ${processedData.length} days`);
                    }
                }

                // Update chart data
                chart.data.labels = processedData.map(d => d.timestamp);
                chart.data.datasets[0].data = processedData.map(d => ({
                    x: d.timestamp,
                    y: d.value
                }));

                // Update chart label based on view type
                const baseLabels = {
                    power: 'Power (W)',
                    voltage: 'Voltage (V)', 
                    current: 'Current (mA)',
                    energy: 'Cumulative Energy (kWh)'
                };

                const viewLabels = {
                    full: 'All Individual Timestamps',
                    hourly: 'Hourly Average',
                    daily: 'Daily Average'
                };

                chart.data.datasets[0].label = `${baseLabels[chartType]} - ${viewLabels[viewType]}`;
                chart.update();

                // Show chart and hide loading
                document.getElementById(`${chartType}Chart`).style.display = 'block';
                const loadingElement = document.querySelector(`#${chartType}-chart-container .chart-loading`);
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }

                console.log(`${chartType} chart updated with ${viewType} view (${processedData.length} points, showing ${viewType === 'full' ? 'ALL' : 'grouped'} timestamps)`);

            } catch (error) {
                console.error(`${chartType} chart update error:`, error);
                showAlert('error', `Failed to update ${chartType} chart: ${error.message}`);
            }
        }

        function prepareFullDataView(data, chartType) {
            const result = [];
            let cumulativeEnergy = 0;

            data.forEach((record, index) => {
                const timestamp = new Date(record.timestamp);
                let value = null;

                switch(chartType) {
                    case 'power':
                        value = record.power;
                        break;
                    case 'voltage':
                        value = record.voltage;
                        break;
                    case 'current':
                        value = record.current;
                        break;
                    case 'energy':
                        if (record.power !== null && record.power !== undefined) {
                            if (index > 0) {
                                const prevRecord = data[index - 1];
                                if (prevRecord.power !== null) {
                                    const timeDiffHours = (timestamp - new Date(prevRecord.timestamp)) / (1000 * 60 * 60);
                                    const avgPower = (record.power + prevRecord.power) / 2;
                                    const energyIncrement = (avgPower * timeDiffHours) / 1000; // kWh
                                    cumulativeEnergy += energyIncrement;
                                }
                            }
                            value = cumulativeEnergy;
                        }
                        break;
                }

                if (value !== null && value !== undefined) {
                    result.push({
                        timestamp: timestamp,
                        value: value
                    });
                }
            });

            console.log(`Full data view prepared: ${result.length} individual data points`);
            return result;
        }

        function prepareHourlyDataView(data, chartType) {
            const hourlyData = {};
            let cumulativeEnergy = 0;

            // Group data by hour
            data.forEach(record => {
                const timestamp = new Date(record.timestamp);
                const hourKey = `${timestamp.getFullYear()}-${String(timestamp.getMonth()).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')}-${String(timestamp.getHours()).padStart(2, '0')}`;

                if (!hourlyData[hourKey]) {
                    hourlyData[hourKey] = {
                        timestamp: new Date(timestamp.getFullYear(), timestamp.getMonth(), timestamp.getDate(), timestamp.getHours()),
                        values: [],
                        powerValues: [],
                        count: 0
                    };
                }

                hourlyData[hourKey].count++;

                switch(chartType) {
                    case 'power':
                        if (record.power !== null && record.power !== undefined) {
                            hourlyData[hourKey].values.push(record.power);
                        }
                        break;
                    case 'voltage':
                        if (record.voltage !== null && record.voltage !== undefined) {
                            hourlyData[hourKey].values.push(record.voltage);
                        }
                        break;
                    case 'current':
                        if (record.current !== null && record.current !== undefined) {
                            hourlyData[hourKey].values.push(record.current);
                        }
                        break;
                    case 'energy':
                        if (record.power !== null && record.power !== undefined) {
                            hourlyData[hourKey].powerValues.push(record.power);
                        }
                        break;
                }
            });

            // Process hourly data
            const result = [];
            const sortedKeys = Object.keys(hourlyData).sort();
            
            sortedKeys.forEach(key => {
                const hourData = hourlyData[key];
                let value = null;

                if (chartType === 'energy') {
                    if (hourData.powerValues.length > 0) {
                        const avgPower = hourData.powerValues.reduce((a, b) => a + b, 0) / hourData.powerValues.length;
                        const hourlyEnergyKWh = avgPower / 1000; // kWh for 1 hour
                        cumulativeEnergy += hourlyEnergyKWh;
                        value = cumulativeEnergy;
                    }
                } else {
                    if (hourData.values.length > 0) {
                        value = hourData.values.reduce((a, b) => a + b, 0) / hourData.values.length;
                    }
                }

                if (value !== null) {
                    result.push({
                        timestamp: hourData.timestamp,
                        value: value,
                        dataPoints: hourData.count
                    });
                }
            });

            console.log(`Hourly ${chartType} data prepared: ${result.length} hours`);
            return result;
        }

        function prepareDailyDataView(data, chartType) {
            const dailyData = {};
            let cumulativeEnergy = 0;

            // Group data by day
            data.forEach(record => {
                const timestamp = new Date(record.timestamp);
                const dayKey = `${timestamp.getFullYear()}-${String(timestamp.getMonth()).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')}`;

                if (!dailyData[dayKey]) {
                    dailyData[dayKey] = {
                        timestamp: new Date(timestamp.getFullYear(), timestamp.getMonth(), timestamp.getDate()),
                        values: [],
                        powerValues: [],
                        count: 0
                    };
                }

                dailyData[dayKey].count++;

                switch(chartType) {
                    case 'power':
                        if (record.power !== null && record.power !== undefined) {
                            dailyData[dayKey].values.push(record.power);
                        }
                        break;
                    case 'voltage':
                        if (record.voltage !== null && record.voltage !== undefined) {
                            dailyData[dayKey].values.push(record.voltage);
                        }
                        break;
                    case 'current':
                        if (record.current !== null && record.current !== undefined) {
                            dailyData[dayKey].values.push(record.current);
                        }
                        break;
                    case 'energy':
                        if (record.power !== null && record.power !== undefined) {
                            dailyData[dayKey].powerValues.push(record.power);
                        }
                        break;
                }
            });

            // Process daily data
            const result = [];
            const sortedKeys = Object.keys(dailyData).sort();
            
            sortedKeys.forEach(key => {
                const dayData = dailyData[key];
                let value = null;

                if (chartType === 'energy') {
                    if (dayData.powerValues.length > 0) {
                        const avgPower = dayData.powerValues.reduce((a, b) => a + b, 0) / dayData.powerValues.length;
                        const dailyEnergyKWh = (avgPower * 24) / 1000; // kWh for 24 hours
                        cumulativeEnergy += dailyEnergyKWh;
                        value = cumulativeEnergy;
                    }
                } else {
                    if (dayData.values.length > 0) {
                        value = dayData.values.reduce((a, b) => a + b, 0) / dayData.values.length;
                    }
                }

                if (value !== null) {
                    result.push({
                        timestamp: dayData.timestamp,
                        value: value,
                        dataPoints: dayData.count
                    });
                }
            });

            console.log(`Daily ${chartType} data prepared: ${result.length} days`);
            return result;
        }

        function updateDataTable() {
            const tbody = document.getElementById('data-table-body');
    
    if (currentMode === 'api') {
        // In API mode, table is updated by real-time simulation
        if (tbody.children.length === 0 || tbody.children[0].textContent.includes('No data loaded')) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="no-data">
                        Real-time data will appear here when device is active...
                    </td>
                </tr>
            `;
        }
        return;
    }

    // CSV mode - show historical data
    tbody.innerHTML = '';

    if (deviceState.historicalData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="no-data">
                    No data loaded. Please upload CSV file from Tuya platform.
                </td>
            </tr>
        `;
        return;
    }

    // Show last 200 records with precise timestamps
    const recentData = deviceState.historicalData.slice(-200);
    recentData.reverse().forEach((record, index) => {
        // Use precise timestamp from CSV
        const preciseTimestamp = new Date(record.timestamp).toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            fractionalSecondDigits: 3,
            hour12: false
        });

        // Add Power data row
        if (record.power !== null && record.power !== undefined) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${preciseTimestamp}</td>
                <td>Power</td>
                <td>${record.power.toFixed(4)}</td>
                <td>W</td>
                <td>Tuya Platform</td>
            `;
            tbody.appendChild(row);
        }

        // Add Voltage data row
        if (record.voltage !== null && record.voltage !== undefined) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${preciseTimestamp}</td>
                <td>Voltage</td>
                <td>${record.voltage.toFixed(2)}</td>
                <td>V</td>
                <td>Tuya Platform</td>
            `;
            tbody.appendChild(row);
        }

        // Add Current data row
        if (record.current !== null && record.current !== undefined) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${preciseTimestamp}</td>
                <td>Current</td>
                <td>${record.current.toFixed(1)}</td>
                <td>mA</td>
                <td>Tuya Platform</td>
            `;
            tbody.appendChild(row);
        }

        // Calculate and add Energy (kWh) data row
        if (record.power !== null && record.power !== undefined) {
            const timeInterval = 1; // 1 minute interval assumption
            const energyWh = (record.power * timeInterval) / 60; // Watt-hours
            const energyKWh = energyWh / 1000; // Convert to kWh

            const energyRow = document.createElement('tr');
            energyRow.innerHTML = `
                <td>${preciseTimestamp}</td>
                <td>Energy</td>
                <td>${energyKWh.toFixed(6)}</td>
                <td>kWh</td>
                <td>Calculated</td>
            `;
            energyRow.style.backgroundColor = '#f0f9ff'; // Light blue background for energy rows
            tbody.appendChild(energyRow);
        }
    });

    console.log(`Data table updated with ${tbody.children.length} rows including precise timestamps and kWh data`);
}

        // Utility functions
        function showCSVStatus(type, message) {
            const statusDiv = document.getElementById('csv-status');
            const messageSpan = document.getElementById('csv-message');
            
            statusDiv.className = `alert ${type}`;
            messageSpan.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showAlert(type, message) {
            const alert = document.getElementById('alert');
            const alertMessage = document.getElementById('alert-message');
            
            alert.className = `alert ${type}`;
            alertMessage.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
